<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Commis</title>
  <style>
    /* Your existing styling remains unchanged */
    @font-face {
      font-family: 'Baloo';
      src: url('fonts/Baloo-Regular.ttf') format('truetype');
    }
    body { font-family: 'Baloo', Arial, sans-serif; background-color: #FAF9F6; color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; padding: 20px; text-align: center; }
    .container { max-width: 600px; padding: 40px; background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .logo { width: 120px; margin-bottom: 20px; }
    h2 { color: #80A85A; margin-bottom: 20px; font-size: 28px; }
    p { font-size: 18px; line-height: 1.6; margin-bottom: 16px; }
    .button { display: inline-block; background-color: #80A85A; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-top: 20px; transition: background-color 0.3s; border: none; cursor: pointer; font-size: 16px; }
    .button:hover { background-color: #6a8f4a; }
    .hidden { display: none; }
    .form-group { margin-bottom: 20px; text-align: left; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
    .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
    .error-message { color: #e74c3c; margin-top: 5px; font-size: 14px; }
    .success-container { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/logo.png" alt="Commis Logo" class="logo">
    <div id="resetForm">
      <h2>Reset Your Password</h2>
      <p>Please enter your new password below.</p>
      <div class="form-group">
        <label for="password">New Password</label>
        <input type="password" id="password" placeholder="Enter new password">
        <div id="passwordError" class="error-message"></div>
      </div>
      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm new password">
        <div id="confirmPasswordError" class="error-message"></div>
      </div>
      <button id="resetButton" class="button">Reset Password</button>
    </div>
    <div id="successMessage" class="success-container">
      <h2>Password Reset Successful!</h2>
      <p>Your password has been successfully reset.</p>
      <p>You can now close this page and log in to the Commis app with your new password.</p>
      <a href="commis://auth-callback?type=reset" id="openAppButton" class="button hidden">Open Commis App</a>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://bmdhdnpvgxfajymddaro.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtZGhkbnB2Z3hmYWp5bWRkYXJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzU4NjcsImV4cCI6MjA2MjIxMTg2N30.BXVWMKljzYH-9av4BNurjzrXGC6SCEoMJQ4G0LJhUyc';  // Replace with your actual anon key
    const supabase = createClient(supabaseUrl, supabaseKey);

    let sessionEstablished = false;

    async function handleSessionFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const refreshToken = hashParams.get('refresh_token');

      if (code) {
        console.log("Code found:", code);
        const { data, error } = await supabase.auth.exchangeCodeForSession(code);
        if (error) {
          alert(`Error exchanging code: ${error.message}`);
        } else {
          console.log("Session exchanged successfully.");
          sessionEstablished = true;
        }
      } else if (accessToken && refreshToken) {
        console.log("Access token and refresh token found in URL fragment.");
        const { error } = await supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
        if (error) {
          alert(`Error setting session: ${error.message}`);
        } else {
          console.log("Session set successfully.");
          sessionEstablished = true;
        }
      } else {
        console.error("No valid session information found.");
        alert('Invalid or missing session. Please request a new password reset link.');
      }
    }

    async function resetPassword() {
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const passwordError = document.getElementById('passwordError');
      const confirmPasswordError = document.getElementById('confirmPasswordError');

      passwordError.textContent = '';
      confirmPasswordError.textContent = '';

      if (password.length < 6) {
        passwordError.textContent = 'Password must be at least 6 characters';
        return;
      }

      if (password !== confirmPassword) {
        confirmPasswordError.textContent = 'Passwords do not match';
        return;
      }

      if (!sessionEstablished) {
        alert('Session not established. Please try again.');
        return;
      }

      const { error } = await supabase.auth.updateUser({ password });
      if (error) {
        alert(`Error updating password: ${error.message}`);
      } else {
        document.getElementById('resetForm').style.display = 'none';
        document.getElementById('successMessage').style.display = 'block';
        setupDeepLink();
      }
    }

    function setupDeepLink() {
      const openAppButton = document.getElementById('openAppButton');
      if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        openAppButton.classList.remove('hidden');
        setTimeout(() => {
          window.location.href = "commis://auth-callback?type=reset";
        }, 1500);
      }
    }

    window.addEventListener('DOMContentLoaded', handleSessionFromUrl);
    document.getElementById('resetButton').addEventListener('click', resetPassword);
  </script>
</body>
</html>
